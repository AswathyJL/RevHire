-- ==========================================================
-- 1. MASTER AUTHENTICATION
-- ==========================================================
CREATE TABLE IF NOT EXISTS users (
    user_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email VARCHAR2(100) UNIQUE NOT NULL,
    password VARCHAR2(255) NOT NULL,
    role VARCHAR2(20) CHECK (role IN ('JOB_SEEKER', 'EMPLOYER')),
    security_question VARCHAR2(255),
    security_answer VARCHAR2(255),
    profile_completion_percent NUMBER DEFAULT 0 CHECK (profile_completion_percent BETWEEN 0 AND 100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ==========================================================
-- 2. PROFILES
-- ==========================================================
CREATE TABLE IF NOT EXISTS job_seeker_profile (
    user_id NUMBER PRIMARY KEY,
    full_name VARCHAR2(100),
    phone VARCHAR2(20),
    location VARCHAR2(100),
    total_experience NUMBER,
    CONSTRAINT fk_js_user FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE IF NOT EXISTS employer_profile (
    user_id NUMBER PRIMARY KEY,
    company_name VARCHAR2(150),
    industry VARCHAR2(100),
    company_size VARCHAR2(50),
    description CLOB,
    website VARCHAR2(150),
    location VARCHAR2(100),
    CONSTRAINT fk_emp_user FOREIGN KEY (user_id) REFERENCES users(user_id)
);

-- ==========================================================
-- 3. RESUME & SUPPLEMENTARY SECTIONS
-- ==========================================================
CREATE TABLE IF NOT EXISTS resume (
    resume_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id NUMBER UNIQUE,
    objective CLOB,
    CONSTRAINT fk_resume_user FOREIGN KEY (user_id) REFERENCES job_seeker_profile(user_id)
);

CREATE TABLE IF NOT EXISTS education (
    education_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    resume_id NUMBER,
    degree VARCHAR2(100),
    institution VARCHAR2(150),
    start_year NUMBER,
    end_year NUMBER,
    CONSTRAINT fk_edu_resume FOREIGN KEY (resume_id) REFERENCES resume(resume_id)
);

CREATE TABLE IF NOT EXISTS experience (
    experience_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    resume_id NUMBER,
    company VARCHAR2(150),
    job_role VARCHAR2(100),
    start_date DATE,
    end_date DATE,
    description CLOB,
    CONSTRAINT fk_exp_resume FOREIGN KEY (resume_id) REFERENCES resume(resume_id)
);

CREATE TABLE IF NOT EXISTS projects (
    project_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    resume_id NUMBER,
    title VARCHAR2(150),
    description CLOB,
    tech_stack VARCHAR2(255),
    CONSTRAINT fk_proj_resume FOREIGN KEY (resume_id) REFERENCES resume(resume_id)
);

CREATE TABLE certifications (
    cert_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    resume_id NUMBER NOT NULL, 
    cert_name VARCHAR2(150),
    issuing_organization VARCHAR2(150),
    issue_date DATE,
    CONSTRAINT fk_cert_resume FOREIGN KEY (resume_id) 
    REFERENCES resume(resume_id) ON DELETE CASCADE
);
-- ==========================================================
-- 4. SKILLS (Many-to-Many)
-- ==========================================================
CREATE TABLE IF NOT EXISTS skills (
    skill_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    skill_name VARCHAR2(100) UNIQUE
);

CREATE TABLE IF NOT EXISTS resume_skills (
    resume_id NUMBER,
    skill_id NUMBER,
    PRIMARY KEY (resume_id, skill_id),
    CONSTRAINT fk_rs_resume FOREIGN KEY (resume_id) REFERENCES resume(resume_id),
    CONSTRAINT fk_rs_skill FOREIGN KEY (skill_id) REFERENCES skills(skill_id)
);

-- ==========================================================
-- 5. JOBS & APPLICATIONS
-- ==========================================================
CREATE TABLE IF NOT EXISTS jobs (
    job_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    employer_id NUMBER,
    title VARCHAR2(150),
    description CLOB,
    experience_required NUMBER,
    education_required VARCHAR2(100),
    location VARCHAR2(100),
    salary_min NUMBER,
    salary_max NUMBER,
    job_type VARCHAR2(20) CHECK (job_type IN ('FULL_TIME', 'PART_TIME', 'INTERNSHIP', 'CONTRACT')),
    deadline DATE,
    status VARCHAR2(10) DEFAULT 'OPEN' CHECK (status IN ('OPEN', 'CLOSED')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_job_employer FOREIGN KEY (employer_id) REFERENCES employer_profile(user_id)
);

CREATE TABLE IF NOT EXISTS job_skills (
    job_id NUMBER,
    skill_id NUMBER,
    PRIMARY KEY (job_id, skill_id),
    CONSTRAINT fk_jskill_job FOREIGN KEY (job_id) REFERENCES jobs(job_id),
    CONSTRAINT fk_jskill_skill FOREIGN KEY (skill_id) REFERENCES skills(skill_id)
);

CREATE TABLE IF NOT EXISTS job_applications (
    application_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    job_id NUMBER,
    user_id NUMBER,
    status VARCHAR2(20) DEFAULT 'APPLIED' CHECK (status IN ('APPLIED', 'SHORTLISTED', 'REJECTED', 'WITHDRAWN')),
    cover_letter CLOB,
    withdrawal_reason VARCHAR2(255), 
    employer_comments CLOB, 
    applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_app_job FOREIGN KEY (job_id) REFERENCES jobs(job_id),
    CONSTRAINT fk_app_user FOREIGN KEY (user_id) REFERENCES job_seeker_profile(user_id)
);

-- ==========================================================
-- 6. SYSTEM UTILITIES
-- ==========================================================
CREATE TABLE IF NOT EXISTS notifications (
    notification_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id NUMBER,
    message CLOB,
    is_read NUMBER(1) DEFAULT 0 CHECK (is_read IN (0,1)),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_notif_user FOREIGN KEY (user_id) REFERENCES users(user_id)
);